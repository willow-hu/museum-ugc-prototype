<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API æµ‹è¯•å·¥å…·</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-top: 0; }
    .section {
      margin: 30px 0;
      padding: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    button {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 5px;
    }
    button:hover { background: #45a049; }
    button.secondary { background: #2196F3; }
    button.secondary:hover { background: #0b7dda; }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 200px;
    }
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 15px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .log-success { color: #4EC9B0; }
    .log-error { color: #F48771; }
    .log-info { color: #9CDCFE; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ åç«¯APIæµ‹è¯•å·¥å…·</h1>
    
    <div class="section">
      <h3>1. å¥åº·æ£€æŸ¥</h3>
      <button onclick="checkHealth()">æ£€æŸ¥åç«¯çŠ¶æ€</button>
    </div>

    <div class="section">
      <h3>2. å‘é€æµ‹è¯•UGCæ•°æ®</h3>
      <input id="participantId" type="text" placeholder="å‚ä¸è€…ID (å¦‚: P001)" value="TEST001">
      <button onclick="sendTestUGC()">å‘é€æµ‹è¯•UGC</button>
    </div>

    <div class="section">
      <h3>3. å‘é€æµ‹è¯•æ—¶é—´è®°å½•</h3>
      <button onclick="sendTestTime()">å‘é€æµ‹è¯•æ—¶é—´è®°å½•</button>
    </div>

    <div class="section">
      <h3>4. æŸ¥çœ‹å‚ä¸è€…æ•°æ®</h3>
      <button class="secondary" onclick="viewParticipant()">æŸ¥çœ‹TEST001æ•°æ®</button>
      <button class="secondary" onclick="viewAllData()">æŸ¥çœ‹æ‰€æœ‰æ•°æ®</button>
    </div>

    <div class="section">
      <h3>5. SessionStorageæ£€æŸ¥</h3>
      <button class="secondary" onclick="checkSessionStorage()">æ£€æŸ¥SessionStorage</button>
      <button class="secondary" onclick="setTestParticipant()">è®¾ç½®æµ‹è¯•å‚ä¸è€…ID</button>
    </div>

    <div class="log" id="log">
      <div class="log-info">>> ç­‰å¾…æ“ä½œ...</div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:3001/api';
    const logDiv = document.getElementById('log');

    function log(message, type = 'info') {
      const className = type === 'error' ? 'log-error' : type === 'success' ? 'log-success' : 'log-info';
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function checkHealth() {
      log('æ£€æŸ¥åç«¯å¥åº·çŠ¶æ€...');
      try {
        const response = await fetch(`${API_BASE}/health`);
        const data = await response.json();
        log(`âœ… åç«¯æ­£å¸¸è¿è¡Œï¼å‚ä¸è€…æ•°é‡: ${data.participants}`, 'success');
        log(JSON.stringify(data, null, 2), 'info');
      } catch (error) {
        log(`âŒ åç«¯è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        log('è¯·ç¡®ä¿åç«¯å·²å¯åŠ¨ (npm run dev)', 'error');
      }
    }

    async function sendTestUGC() {
      const participantId = document.getElementById('participantId').value;
      if (!participantId) {
        log('âŒ è¯·è¾“å…¥å‚ä¸è€…ID', 'error');
        return;
      }

      const payload = {
        participantId,
        content: 'è¿™æ˜¯æµ‹è¯•UGCå†…å®¹',
        artifactId: 'TEST_ARTIFACT',
        mode: 'comment_board',
        timestamp: Date.now()
      };

      log('å‘é€æµ‹è¯•UGCæ•°æ®...');
      log(JSON.stringify(payload, null, 2), 'info');

      try {
        const response = await fetch(`${API_BASE}/data/ugc`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          log('âœ… UGCæ•°æ®å‘é€æˆåŠŸï¼', 'success');
          log(JSON.stringify(result, null, 2), 'success');
        } else {
          const error = await response.text();
          log(`âŒ å‘é€å¤±è´¥ (${response.status}): ${error}`, 'error');
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function sendTestTime() {
      const participantId = document.getElementById('participantId').value;
      if (!participantId) {
        log('âŒ è¯·è¾“å…¥å‚ä¸è€…ID', 'error');
        return;
      }

      const payload = {
        participantId,
        mode: 'comment_board',
        artifactId: 'TEST_ARTIFACT',
        exitTime: Date.now(),
        durationMs: 30000
      };

      log('å‘é€æµ‹è¯•æ—¶é—´è®°å½•...');
      log(JSON.stringify(payload, null, 2), 'info');

      try {
        const response = await fetch(`${API_BASE}/data/time`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          const result = await response.json();
          log('âœ… æ—¶é—´è®°å½•å‘é€æˆåŠŸï¼', 'success');
          log(JSON.stringify(result, null, 2), 'success');
        } else {
          const error = await response.text();
          log(`âŒ å‘é€å¤±è´¥ (${response.status}): ${error}`, 'error');
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function viewParticipant() {
      const participantId = document.getElementById('participantId').value;
      log(`æŸ¥çœ‹å‚ä¸è€… ${participantId} çš„æ•°æ®...`);
      
      try {
        const response = await fetch(`${API_BASE}/data/${participantId}`);
        if (response.ok) {
          const data = await response.json();
          log('âœ… å‚ä¸è€…æ•°æ®:', 'success');
          log(JSON.stringify(data, null, 2), 'success');
        } else if (response.status === 404) {
          log('âš ï¸ å‚ä¸è€…ä¸å­˜åœ¨', 'error');
        } else {
          log(`âŒ è·å–å¤±è´¥ (${response.status})`, 'error');
        }
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
      }
    }

    async function viewAllData() {
      log('æŸ¥çœ‹æ‰€æœ‰æ•°æ®...');
      try {
        const response = await fetch(`${API_BASE}/data/export/all`);
        const data = await response.json();
        log('âœ… æ‰€æœ‰æ•°æ®:', 'success');
        log(`æ€»å‚ä¸è€…æ•°: ${data.totalParticipants}`, 'success');
        log(JSON.stringify(data, null, 2), 'info');
      } catch (error) {
        log(`âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
      }
    }

    function checkSessionStorage() {
      log('æ£€æŸ¥ SessionStorage...');
      const participantId = sessionStorage.getItem('participantId');
      if (participantId) {
        log(`âœ… æ‰¾åˆ°å‚ä¸è€…ID: ${participantId}`, 'success');
      } else {
        log('âš ï¸ SessionStorage ä¸­æ²¡æœ‰ participantId', 'error');
        log('å‰ç«¯å¯èƒ½æ— æ³•å‘é€æ•°æ®ï¼', 'error');
      }
    }

    function setTestParticipant() {
      const participantId = document.getElementById('participantId').value;
      sessionStorage.setItem('participantId', participantId);
      log(`âœ… å·²è®¾ç½® participantId = ${participantId}`, 'success');
      log('ç°åœ¨å¯ä»¥æµ‹è¯•å‰ç«¯å‘é€åŠŸèƒ½', 'info');
    }

    // è‡ªåŠ¨æ£€æŸ¥å¥åº·çŠ¶æ€
    window.onload = () => {
      log('=== API æµ‹è¯•å·¥å…·å·²å°±ç»ª ===', 'success');
      checkHealth();
    };
  </script>
</body>
</html>
